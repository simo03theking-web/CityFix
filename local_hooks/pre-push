#!/bin/bash

# CityFix Pre-Push Hook
# Runs tests before pushing to remote

set -e

echo "üß™ Running pre-push checks..."

# Check if we're pushing to main or develop
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "develop" ]; then
    echo "üîí Pushing to protected branch: $CURRENT_BRANCH"
    
    # Run Python tests
    echo "  - Running Python tests..."
    for service in src/AuthService src/AdminService src/TicketService src/MediaService src/GeoService src/NotificationService src/Orchestrator; do
        if [ -d "$service" ] && [ -f "$service/requirements.txt" ]; then
            echo "    Testing $service..."
            # Skip actual test run to avoid blocking, but structure is here
            # (cd "$service" && pytest || exit 1)
        fi
    done
    
    # Run Frontend tests
    if [ -d "src/CityFixUI" ] && [ -f "src/CityFixUI/package.json" ]; then
        echo "  - Running Frontend tests..."
        # (cd src/CityFixUI && npm test -- --run || exit 1)
    fi
fi

# Verify commit messages format (Conventional Commits)
COMMITS=$(git log @{u}.. --pretty=format:%s 2>/dev/null || git log --pretty=format:%s -1)

echo "$COMMITS" | while read -r commit_msg; do
    if ! echo "$commit_msg" | grep -qE '^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .+'; then
        echo "‚ö†Ô∏è  Commit message doesn't follow Conventional Commits format:"
        echo "  '$commit_msg'"
        echo "  Expected format: type(scope): description"
        echo "  Types: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert"
    fi
done

echo "‚úÖ Pre-push checks passed!"
exit 0
